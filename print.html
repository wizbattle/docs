<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>wizbattle</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="dev.html"><strong aria-hidden="true">2.</strong> For Developers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="dev/vm.html"><strong aria-hidden="true">2.1.</strong> VM Design</a></li><li class="chapter-item expanded "><a href="dev/bytecode.html"><strong aria-hidden="true">2.2.</strong> Bytecode</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">wizbattle</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This manual is the primary source of documentation for wizbattle, both for
developers and regular players. It describes the game features, the inner
workings and the future plans for the project.</p>
<h2 id="what-is-wizbattle"><a class="header" href="#what-is-wizbattle">What is wizbattle?</a></h2>
<p>wizbattle is an online game which simulates Wizard101 combat mechanics. It
is fully open source under the GNU GPLv2 license.</p>
<p>The primary mechanic is PvP with access to gear and spells without grinding,
which allows rapid testing and adapting of strategies.</p>
<p>We feature various metagames, one of them being the official ingame ladder,
but also various customized modes where people can time-travel or use
inaccessible spells and gear.</p>
<h2 id="licensing"><a class="header" href="#licensing">Licensing</a></h2>
<p>The text of this book is provided as-is under the terms of the
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> license.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="for-developers"><a class="header" href="#for-developers">For Developers</a></h1>
<p>This chapter discusses the technologies we use internally to help developers
familiarize themselves with the stack.</p>
<p>Whether you plan to contribute or want to adapt parts of wizbattle for your
own project, this section got you covered. We have additional information of
for contributors in another chapter. </p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vm-design"><a class="header" href="#vm-design">VM Design</a></h1>
<p>The game uses a <em>Virtual Machine</em> on the server side to handle spells
in combat. This chapter explains the design of the VM and how it works.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>This approach brings several advantages with it, which outweigh the
other considered options:</p>
<ul>
<li>
<p><strong>Data, not code:</strong> Spells are decoupled from the implementation and
can be modified and added without needing to recompile the server.</p>
</li>
<li>
<p><strong>Sandboxed:</strong> Malicious or buggy spells can't bring the game down
while still allowing for easy debugging.</p>
</li>
<li>
<p><strong>Compact:</strong> Bytecode images of spells are significantly smaller in
size than their C++ object representations.</p>
</li>
<li>
<p><strong>Stable:</strong> We can ensure a stable data format to store even between
changes to the game's C++ types between revisions.</p>
<p>This is also attractive for relational databases because OOP class
hierarchies don't lend themselves to nice database schemas.</p>
</li>
<li>
<p><strong>Efficient:</strong> Spells have minimal resource footprint, which keeps
the server manageable even under heavy load.</p>
</li>
<li>
<p><strong>Accurate:</strong> A spell's bytecode can be disassembled and turned into
an accurate description of effects for human players. This may help
with familiarizing with new game mechanics when they're released.</p>
</li>
</ul>
<h2 id="registers"><a class="header" href="#registers">Registers</a></h2>
<p>The wizbattle Virtual Machine is register-based. It supports reading
and writing values to them and do maths in-between.</p>
<p>We feature a total of 16 registers, 4 of them for general-purpose
computations and 12 for special-purpose setup.</p>
<p>The special-purpose registers are zeroed after every spell. Code generators
may rely on this behavior and don't have to do manual cleanup.</p>
<h3 id="gprs"><a class="header" href="#gprs">GPRs</a></h3>
<p>The 4 GPRs are labeled <code>0</code> through <code>3</code> and behave identical. Use them as
you wish with no drawbacks.</p>
<h3 id="zero"><a class="header" href="#zero">ZERO</a></h3>
<p>A 32-bit special-purpose register that always reads <code>0</code> and ignores writes,
labeled <code>4</code>.</p>
<h3 id="arg"><a class="header" href="#arg">ARG</a></h3>
<p>A 32-bit signed integer argument to the spell, labeled <code>5</code>.</p>
<p>Most of the time, this will be the base damage or base healing amount of
a spell. In other cases, this may not be used at all.</p>
<p>Spells are expected to load this value in on demand.</p>
<h3 id="tgt"><a class="header" href="#tgt">TGT</a></h3>
<p>Encodes the target of the spell, labeled <code>6</code>.</p>
<p>Below is an illustration of the register's bitfield:</p>
<pre><code> 31                                7  6   5  4   0
+-----------------------------------+---+---+-----+
|                                   |   |   |     |
|                RESERVED           | C |DIV| SEL |
|                                   |   |   |     |
+-----------------------------------+---+---+-----+
</code></pre>
<p><strong>SEL</strong>: The effect target according to <code>enum SpellEffect::kEffectTarget</code>.</p>
<p><strong>DIV</strong>: Whether damage should be divided between the targets.</p>
<p><strong>C</strong>: Whether critical hit rolls are disabled for this spell.</p>
<h3 id="ap"><a class="header" href="#ap">AP</a></h3>
<p>A 32-bit signed integer argument to encode additional armor piercing,
labeled <code>7</code>.</p>
<h3 id="reserved"><a class="header" href="#reserved">Reserved</a></h3>
<p>The registers <code>8</code> through <code>15</code> are currently not in use and reserved
for future extensions.</p>
<h2 id="instructions"><a class="header" href="#instructions">Instructions</a></h2>
<p>The VM executes a linear stream of instructions (commands), which modify
its internal state and carry out the logic to modify the game state.</p>
<h3 id="arithmetic"><a class="header" href="#arithmetic">Arithmetic</a></h3>
<blockquote>
<p><strong>MOV $dst, $src</strong>: Moves a value from the source register to the destination register.</p>
</blockquote>
<blockquote>
<p><strong>LOAD $dst, off</strong>: Loads a 32-bit constant into $dst from byte offset <code>off &lt;&lt; 1</code>.</p>
</blockquote>
<blockquote>
<p><strong>ADD $dst, $src</strong>: Adds the source register to the destination register.</p>
</blockquote>
<blockquote>
<p><strong>MUL $dst, $src</strong>: Multiplies the destination register with the source register.</p>
</blockquote>
<blockquote>
<p><strong>DIV $dst, $src</strong>: Divides the destination register by the source register.</p>
</blockquote>
<blockquote>
<p><strong>AND $dst, $src</strong>: Bitwise AND of destination register and source register.</p>
</blockquote>
<blockquote>
<p><strong>OR $dst, $src</strong>: Bitwise OR of destination register and source register.</p>
</blockquote>
<blockquote>
<p><strong>XOR $dst, $src</strong>: Bitwise XOR of destination register and source register.</p>
</blockquote>
<blockquote>
<p><strong>BSET $dst, idx</strong>: Sets a bit of a given index in the destination register.</p>
</blockquote>
<h3 id="branch"><a class="header" href="#branch">Branch</a></h3>
<blockquote>
<p><strong>JMP off</strong>: Unconditionally jumps over <code>off &lt;&lt; 1</code> code bytes.</p>
</blockquote>
<blockquote>
<p><strong>J.cond $reg1, $reg2, off</strong>: Conditionally jumps over <code>off &lt;&lt; 1</code> code bytes. The
condition code <code>cond</code> decides how the two input registers are compared.</p>
</blockquote>
<h3 id="external"><a class="header" href="#external">External</a></h3>
<blockquote>
<p><strong>CMD.ATTACK</strong>: Triggers an attack with the setup of special-purpose registers.
Overwrites the base damage in <code>ARG</code> with the actual damage dealt.</p>
</blockquote>
<blockquote>
<p><strong>CMD.HEAL</strong>: Triggers healing with the setup of special-purpose registers.</p>
</blockquote>
<blockquote>
<p><strong>CMD.DRAIN</strong>: Heals for <code>ARG</code> HP without factoring any additional boosts
to incoming and outgoing healing in.</p>
</blockquote>
<blockquote>
<p><strong>CMD.RESHUFFLE</strong>: Reshuffles the spell deck.</p>
</blockquote>
<blockquote>
<p><strong>CMD.HALT</strong>: Halts execution of the current bytecode image. Hitting the end of
the bytecode image without encountering this instruction is an error.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bytecode"><a class="header" href="#bytecode">Bytecode</a></h1>
<p>This chapter describes the binary encoding of the VM instructions
introduced in the previous chapter.</p>
<blockquote>
<p>TODO</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
